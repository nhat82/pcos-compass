{% extends "header.html" %}
{% block content %}

<div class="profile-container">
    <main class="profile-main">
        <div class="profile-content">
            <div class="profile-header">
                <h1 class="profile-title">
                    {{current_user.username}}'s Profile
                </h1>
            </div>

            <div class="profile-grid">
                <!-- Problems Card -->
                <div class="profile-card">
                    <div class="profile-card-header">
                        <h2 class="profile-card-title">Problems</h2>
                        <button class="btn-add" data-modal="problemModal">
                            <span class="material-symbols-outlined">add</span>
                            Add
                        </button>
                    </div>

                    <!-- Problem Modal -->
                    <div id="problemModal" class="profile-modal">
                        <div class="profile-modal-container">
                            <div class="profile-modal-content">
                                <div class="profile-modal-header">
                                    <h2 class="profile-modal-title">Add a Problem</h2>
                                    <span class="modal-close-btn" data-close="problemModal">&times;</span>
                                </div>
                                <form method="POST" class="profile-form">
                                    {{ problem_form.hidden_tag() }}

                                    <label class="form-group">
                                        <p class="form-label">Select Symptoms:</p>
                                        {{ problem_form.symptoms(class="form-select") }}
                                    </label>

                                    <label class="form-group">
                                        <p class="form-label">And/Or enter a custom symptom:</p>
                                        {{ problem_form.custom_symptom(class="form-input", placeholder="e.g., Severe fatigue") }}
                                    </label>

                                    <div class="pt-4">
                                        {{ problem_form.submit(class="form-submit") }}
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Problems List -->
                    <div class="profile-list">
                        <h3 class="profile-list-title">Your Logged Symptoms</h3>
                        <div class="profile-list-items">
                            {% if user_symptoms %}
                                {% for prob in user_symptoms %}
                                    <div class="profile-list-item">
                                        <div class="profile-item-content">
                                            <div class="profile-item-icon profile-item-icon-problem">
                                                <span class="material-symbols-outlined">error</span>
                                            </div>
                                            <div class="profile-item-details">
                                                <p class="profile-item-name">{{ prob.name }}</p>
                                                {% if prob.details %}
                                                    <p class="profile-item-description">{{ prob.details }}</p>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <p class="profile-empty-state">No symptoms logged yet.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Treatments Card -->
                <div class="profile-card">
                    <div class="profile-card-header">
                        <h2 class="profile-card-title">Treatments</h2>
                    </div>

                    <div class="profile-list">
                        <h3 class="profile-list-title">Your Logged Treatments</h3>
                        <div class="profile-list-items">
                            {% if user_treatments %}
                                {% for treat in user_treatments %}
                                    <div class="profile-list-item">
                                        <div class="profile-item-content">
                                            <div class="profile-item-icon profile-item-icon-treatment">
                                                <span class="material-symbols-outlined">pill</span>
                                            </div>
                                            <div class="profile-item-details">
                                                <p class="profile-item-name">{{ treat.treatment_name }}</p>
                                                {% if treat.description %}
                                                    <p class="profile-item-description">{{ treat.description }}</p>
                                                {% endif %}
                                                <p class="profile-item-date">
                                                    {% if treat.start_date %}{{ treat.start_date.strftime('%Y-%m-%d') }}{% endif %}
                                                    {% if treat.end_date %} to {{ treat.end_date.strftime('%Y-%m-%d') }}{% endif %}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <p class="profile-empty-state">No treatments logged yet.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Keep your existing JavaScript as is -->
<script>
    // MODAL TOGGLE FUNCTIONS
    document.addEventListener('DOMContentLoaded', function() {
        // Add button functionality
        document.querySelectorAll(".btn-add").forEach(btn => {
            btn.addEventListener("click", (e) => {
                e.preventDefault();
                const modalId = btn.getAttribute("data-modal");
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = "block";
                }
            });
        });

        // Close button functionality
        document.querySelectorAll(".modal-close-btn").forEach(closeBtn => {
            closeBtn.addEventListener("click", (e) => {
                e.preventDefault();
                const modalId = closeBtn.getAttribute("data-close");
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = "none";
                }
            });
        });

        // Close modal when clicking outside
        window.addEventListener("click", (event) => {
            document.querySelectorAll(".profile-modal").forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = "none";
                }
            });
        });

        // END DATE TOGGLE FOR TREATMENTS (if applicable)
        const ongoingSelect = document.getElementById("ongoingSelect");
        const endDateWrapper = document.getElementById("endDateWrapper");

        if (ongoingSelect && endDateWrapper) {
            function toggleEndDate() {
                if (ongoingSelect.value === "True" || ongoingSelect.value === "true") { 
                    endDateWrapper.style.display = "none"; 
                } else {
                    endDateWrapper.style.display = "block";
                }
            }

            toggleEndDate();
            ongoingSelect.addEventListener("change", toggleEndDate);
        }
    });
</script>

{% endblock %}